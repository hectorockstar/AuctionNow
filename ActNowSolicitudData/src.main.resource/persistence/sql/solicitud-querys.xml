<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.auctionnow.data.solicitud">

	<resultMap id="solicitud-mapping" type="com.auctionnow.model.Solicitud" >
		<result property="codigoSolicitud"           column="S_CODSOLICITUD" />
		<result property="estadoSolicitud"           column="S_ESTADOSOL" />
		<result property="descripcion"               column="S_DESCRIPCION" />
		<result property="fechaCreacion"             column="S_FECHACREACION" />
		<result property="fechaEntregaServicio"      column="S_FECHAESPECIFICA" />
		<result property="fechaServicioDesde"        column="S_FECHASERVICIODESDE" />
		<result property="fechaServicioHasta"        column="S_FECHASERVICIOHASTA" />
		<result property="horarioDesde"              column="S_HRSERVICIODESDE" />
		<result property="horarioHasta"              column="S_HRSERVICIOHASTA" />
		<result property="fechaVencimientoSubasta"   column="S_FECHAVENCIMIENTOSUB" />
		<result property="horaVencimientoSubasta"    column="S_HRVENCIMIENTOSUB" />
		<result property="precioEsperado"            column="S_PRECIOESTIMADO" />
		<result property="valoracion"                column="S_VALORACION" />
		<result property="activo"                    column="S_ACTIVO" />
		<result property="tipoFecha.id"              column="S_TIPOFECHA" />
		<result property="cliente.codigoCliente"     column="S_CODCLIENTE" />
		<result property="servicio.codigoServicio"   column="S_CODSERVICIO" />
		<result property="direccion.codigoDireccion" column="S_CODDIRECCION" />
		<result property="contacto.codigoContacto"   column="S_CODCONTACTO" />
	</resultMap>
	
	<resultMap id="subasta-mapping" type="com.auctionnow.model.Subasta" >
		
		<result property="codigoSubasta"               column="S_CODIGOSUBASTA" />
		<result property="estadoSubasta"               column="S_ESTADO" />
		<result property="descripcion"                 column="S_DESCRIPCION" />
		<result property="fechaSubastaDesde"           column="S_FECHAINICIO" />
		<result property="horaInicioSubasta"           column="S_HRINICIOSUBASTA" />
		<result property="fechaSubastaHasta"           column="S_FECHATERMINO" />
		<result property="horaTerminoSubasta"          column="S_HRTERMINOSUBASTA" />
		<result property="duracion"                    column="S_DURACION" />
		<result property="cantidadExtensiones"         column="S_CANTIDADEXTENSIONES" />
		<result property="montoMinimo"                 column="S_MONTOMINIMO" />
		<result property="montoInicial"                column="S_MONINICIAL" />
		<result property="montoFinal"                  column="S_MONTOFINAL" />
		<result property="servicio.codigoServicio"     column="S_CODIGOSERVICIO" />
		<result property="solicitud.codigoSolicitud"   column="S_CODIGOSOLICITUD" />
		<result property="extendida"                   column="S_EXTENDIDA" />
		<result property="ofertaGanadora.codigoOferta" column="S_CODIGOOFERTAGANADORA" />
	</resultMap>
	
	<resultMap id="oferta-mapping" type="com.auctionnow.model.Oferta" >
		<result property="codigoOferta"              column="O_CODIGOOFERTA" />
		<result property="montoOferta"               column="O_MONTOOFERTA" />
		<result property="proveedor.codigoProveedor" column="O_CODIGOPROVEEDOR" />
		<result property="valorAgregado"             column="O_COMISION" />
		<result property="fechaOferta"               column="O_FECHAOFERTA" />
		<result property="codigoSubasta"             column="O_CODIGOSUBASTA" />
	</resultMap>
	
	<select id="getSolicitud" resultMap="solicitud-mapping" parameterType="com.auctionnow.filters.FiltroSolicitud">
		SELECT 
			SOL.C_CODSOL        AS S_CODSOLICITUD,
			SOL.T_DESCRIPCION   AS S_DESCRIPCION,
			SOL.T_ESTADO        AS S_ESTADOSOL,
			SOL.D_FECCREASOL    AS S_FECHACREACION,
			SOL.D_FECESPECIFICA AS S_FECHAESPECIFICA,
			SOL.D_FECSERDESDE   AS S_FECHASERVICIODESDE,
			SOL.D_FECSERHASTA   AS S_FECHASERVICIOHASTA,
			SOL.T_HRSERDESDE    AS S_HRSERVICIODESDE,
			SOL.T_HRSERHASTA    AS S_HRSERVICIOHASTA,
			SOL.D_FECVENSUB     AS S_FECHAVENCIMIENTOSUB,
			SOL.T_HRVENSUB		AS S_HRVENCIMIENTOSUB,
			SOL.N_PRECIOEST     AS S_PRECIOESTIMADO,
			SOL.N_VALORACION	AS S_VALORACION,
			SOL.T_ACTIVO		AS S_ACTIVO,
			SOL.C_TIPOFECHA		AS S_TIPOFECHA,
			SOL.C_CODCLI        AS S_CODCLIENTE,
			SOL.C_CODSER        AS S_CODSERVICIO,
			SOL.C_CODDIR        AS S_CODDIRECCION,
			SOL.C_CODCON		AS S_CODCONTACTO
			
		FROM AN_SOLICITUD SOL
		
		WHERE SOL.C_CODSOL = #{codigoSolicitud}
		
		<if test="codigoCliente != null and codigoCliente != ''">
			SOL.C_CODCLI = #{codigoCliente}
		</if>
		
	</select>
	
	<select id="getSubasta" resultMap="subasta-mapping" parameterType="com.auctionnow.filters.FiltroSubasta">
		SELECT 
			SUB.C_CODSUB       AS S_CODIGOSUBASTA,
			SUB.C_ESTADO       AS S_ESTADO,
			SUB.T_DESCRIPCION  AS S_DESCRIPCION,
			SUB.D_FECSUBDESDE  AS S_FECHAINICIO,
			SUB.T_HRSUBINICIO  AS S_HRINICIOSUBASTA,
			SUB.D_FECSUBHASTA  AS S_FECHATERMINO,
			SUB.T_HRSUBTERMINO AS S_HRTERMINOSUBASTA,
			SUB.T_DURACION     AS S_DURACION,
			SUB.N_CANTEXT      AS S_CANTIDADEXTENSIONES,
			SUB.N_MTOMINIMO    AS S_MONTOMINIMO,
			SUB.N_MTOINICIAL   AS S_MONINICIAL,
			SUB.N_MTOFINAL     AS S_MONTOFINAL,
			SUB.C_CODSER       AS S_CODIGOSERVICIO,
			SUB.C_CODSOL       AS S_CODIGOSOLICITUD,
			SUB.C_EXTEND       AS S_EXTENDIDA,
			SUB.C_CODOFERGANA  AS S_CODIGOOFERTAGANADORA
			
		FROM AN_SUBASTA SUB
		
		WHERE SUB.C_CODSUB = #{codigoSubasta}
		
		<if test="codigoSolicitud != null and codigoSolicitud != ''">
			AND SUB.C_CODSOL = #{codigoSolicitud}
		</if>
	</select>
	
	<select id="getOferta" resultMap="oferta-mapping" parameterType="com.auctionnow.filters.FiltroOferta" >
		SELECT 
			OFER.C_CODOFER  AS O_CODIGOOFERTA,
			OFER.D_FECOFER  AS O_FECHAOFERTA,
			OFER.N_COMISION AS O_COMISION,
			OFER.N_MTOOFER  AS O_MONTOOFERTA,
			OFER.C_CODSUB   AS O_CODIGOSUBASTA,
			OFER.C_CODPROV  AS O_CODIGOPROVEEDOR
		
		FROM AN_OFERTA OFER
		
		WHERE 
		
		<if test="codigoOferta != null and codigoOferta != ''">
			OFER.C_CODOFER = #{codigoOferta}
		</if>
		
		<if test="codigoOferta == null or codigoOferta == ''">
			<if test="codigoProveedor != null and codigoProveedor != ''">
				OFER.C_CODPROV = #{codigoProveedor}
			</if>
			
			<if test="codigoProveedor != null and codigoProveedor != '' and codigoSubasta != null and codigoSubasta != ''">
				AND
			</if>
			
			<if test="codigoSubasta != null and codigoSubasta != ''">
				OFER.C_CODSUB = #{codigoSubasta}
			</if>
		</if>
	</select>

	<!-- INSERTs -->
	<insert id="addSolicitud" parameterType="map">
		INSERT INTO AN_SOLICITUD (
			C_CODSOL,
			T_DESCRIPCION,
			T_ESTADO,
			D_FECCREASOL,
			D_FECESPECIFICA,
			D_FECSERDESDE,
			D_FECSERHASTA,
			T_HRSERDESDE,
			T_HRSERHASTA,
			D_FECVENSUB,
			T_HRVENSUB,
			N_PRECIOEST,
			N_VALORACION,
			T_ACTIVO,
			C_TIPOFECHA,
			C_CODCLI,
			C_CODSER,
			C_CODDIR,
			C_CODCON 
		) VALUES (
			#{codigoSolicitud},
			#{descripcion},
			#{estadoSolicitud},
			#{fechaCreacionSolicitud},
			#{fechaServicioEspecifica},
			#{fechaServicioDesde},
			#{fechaServicioHasta},
			#{horaServicioDesde},
			#{horaServicioHasta},
			#{fechaVencimientoSubasta},
			#{horaVencimientoSubasta},
			#{precioEstimado},
			#{valoracion},
			#{activo},
			#{tipoFecha},
			#{codigoCliente},
			#{codigoServicio},
			#{codigoDireccion},
			#{codigoContacto}
		)
	</insert>
	
	<insert id="addSubasta" parameterType="map">
		INSERT INTO AN_SUBASTA (
			C_CODSUB,
			C_ESTADO,
			T_DESCRIPCION,
			D_FECSUBDESDE,
			T_HRSUBINICIO,
			D_FECSUBHASTA,
			T_HRSUBTERMINO,
			T_DURACION,
			N_CANTEXT,
			N_MTOMINIMO,
			N_MTOINICIAL,
			N_MTOFINAL,
			C_CODSER, 
			C_CODSOL,
			C_EXTEND,
			C_CODOFERGANA
		) VALUES (
			#{codigoSubasta},
			#{estadoSubasta},
			#{descripcion},
			#{fechaSubastaDesde},
			#{horaInicioSubasta},
			#{fechaSubastaHasta},
			#{horaTerminoSubasta},
			#{duracion},
			#{cantidadExtensiones},
			#{montoMinimo},
			#{montoInicial},
			#{montoFinal},
			#{codigoServicio},
			#{codigoSolicitud},
			#{extendida},
			#{codigoOfertaGanadora}
		)
	</insert>
	
	<insert id="addOferta" parameterType="map">
		INSERT INTO AN_OFERTA (
			C_CODOFER,
			D_FECOFER,
			N_COMISION,
			N_MTOOFER,
			C_CODPROV,
			C_CODSUB
		) VALUES (
			#{codigoOferta},
			#{fechaOferta},
			#{comision},
			#{montoOferta},
			#{codigoProveedor},
			#{codigoSubasta}
		)
	</insert>
	
	<insert id="addSubastaProveedor" parameterType="map" >
		INSERT INTO AN_SUBASTA_PROVEEDOR (
			C_CODPROV,
			C_CODSUB,
			T_ESTADO,
			D_FECREG
		) VALUES (
			#{codigoProveedor},
			#{codigoSubasta},
			#{estado},
			#{fechaRegistro}
		)	
	</insert>
	
	<!-- UPDATEs -->
	<update id="updateSolicitud" parameterType="map" >
		UPDATE AN_SOLICITUD
		SET T_DESCRIPCION = #{descripcion},
			T_ESTSOL = #{estadoSolicitud},
			D_FECCREA = #{fecCreacion},
			D_FECVEN = #{fecVencimiento},
			N_PRECEST = #{precioEstimado},
			N_PRIOR = #{prioridad},
			C_CODCLI = #{codigoCliente},
			C_CODSER = #{codigoServicio},
			C_CODDIR = #{codigoDireccion}
		WHERE C_CODSOL = #{codigoSolicitud}
	</update>
	
	<update id="updateSubasta" parameterType="map">
		UPDATE AN_SUBASTA
		SET C_ESTADO = #{estado},
			D_FECINI = #{fecInicio},
			D_FECTER = #{fecTermino},
			T_DURACION = #{duracion},
			N_CANTEXT = #{cantidadExtnsions},
			N_MTOMIN = #{montoMinimo},
			N_MTOINI = #{montoInicial},
			N_MTOFINAL = #{montoFinal},
			C_EXTEND = #{extendida},
			T_DESCRIPCION = #{descripcion},
			C_CODOFEG = #{codigoOfertaG},
			C_CODSER = #{codigoServicio}
		WHERE C_CODSUB = #{codigoSubasta}
		<!-- AND C_CODSOL = #{codigoSolicitud}  -->
	</update>
	
	<update id="updateOferta" parameterType="map">
		UPDATE AN_OFERTA
		SET D_FECOFER = #{fechaOferta},
			N_COMISION = #{comision},
			N_MTOOFER = #{montoOferta},
			C_CODPROV = #{codigoProveedor}
		WHERE C_CODOFER = #{codigoOferta}
		AND C_CODSUB = #{codigoSubasta}
	</update>

</mapper>